{% extends '../subpages_base.html' %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% block title %}
    <title>Retrieve Post | DIY CONNECT</title>
    {% endblock title %}

    <style>
      /*{% block styles %}*/
      .sty-role-not-selected:hover {
        cursor: default !important;
      }
      .sty-role-not-selected {
        color: #283618 !important;
      }
      .sty-sect-cl-opt {
        background-color: #283618;
      }
      .sty-sect-opt-icon {
        font-size: 38px;
        color: #ffffff;
      }
      .sty-sect-opt-icon:hover {
        cursor: pointer !important;
      }
      .sty-sect-opt {
        font-size: 40px;
        color: #ffffff;
        border: solid #ffffff 1px;
      }

      .sty-mdl-footer-btn {
        width: 100%;
        display: flex;
        justify-content: center;
      }
      .sty-mdl-head {
        font-size: 36px;
        font-weight: 800;
        color: black;
      }
      .sty-mdl-msg {
        font-size: 20px;
        font-weight: 400;
        color: black;
      }

      .sty-mdl-btn-submit {
        color: #ffffff;
        font-weight: 600;
        background-color: #283618;
        font-size: 25px;
      }

      .profile-img-circle {
        width: 64px;
        height: 64px;
        object-fit: cover; /* ensures the image covers the box without distortion */
        border-radius: 50%;
      }

      .nav-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 2rem;
        background: rgba(255, 255, 255, 0.6);
        border: none;
        z-index: 10;
      }

      .left-arrow {
        left: 10px;
      }

      .right-arrow {
        right: 10px;
      }

      /* Mobile */
      @media (max-width: 768px) {
        .sty-header-big-font-size {
          font-size: 30px !important;
        }
        .sty-subtitle-low-font-size-mobile {
          font-size: 13px !important;
          padding-bottom: 2rem;
          padding-top: 2rem;
        }

        .sty-inp-postAdd-image {
          height: 330px !important;
          width: 90vw !important;
        }

        .sty-sect-opt-icon {
          font-size: 30px;
          padding-left: 1rem !important;
          padding-right: 1rem !important;
        }
        .sty-sect-opt {
          font-size: 30px;
          padding-left: 1rem !important;
          padding-right: 1rem !important;
        }
        #desc_onchange {
          font-size: 10px;
        }

        .nav-arrow {
          font-size: 1.5rem; /* Slightly smaller for mobile */
          top: 45%;
          padding: 0.3rem 0.6rem;
          background: rgba(255, 255, 255, 0.8);
        }

        .left-arrow {
          left: 5px; /* Tighter margin */
        }

        .right-arrow {
          right: 5px;
        }

        #mdl_viewImage_element {
          max-width: 90vw;
          max-height: 70vh;
          object-fit: contain;
          margin: auto;
        }

        .modal-close {
          top: 5px;
          right: 5px;
        }
      }
      /*{% endblock styles %}*/
    </style>
  </head>
  <body>
    <!-- prettier-ignore -->
    {% block content %}
    <!-- //prettier-ignore -->
    {% if not post_data %}
    <h1>There is no file</h1>
    {% else %}

    <div class="container">
      <div class="columns is-vcentered has-text-centered">
        <div class="column">
          <div>
            <!--
            <input
              type="text "
              placeholder="Add A Title"
              class="input sty-header-big-font-size sty-inp-txt-header sty-header-weight"
              id="inp_title"
            />
            -->

            <!-- prettier-ignore -->
            <textarea readonly
              placeholder="Add A Title"
              name=""
              id="inp_title"
              class="input sty-header-big-font-size sty-inp-txt-header sty-header-weight"
            >
{{ post_data.title}}</textarea
            >
            <!-- //prettier-ignore -->
          </div>
          <div>
            <!-- prettier-ignore -->
            <textarea readonly
              class="textarea sty-inp-txt-subheader mt-2 sty-font-family-hind"
              placeholder="Add a description"
              id="inp_desc"
            >
 {{ post_data.description }}</textarea
            >
            <!-- //prettier-ignore -->
          </div>

          <div class="columns mt-5 is-vcentered sty-sect-cl-opt is-mobile">
            <div class="column is-3-mobile">
              <a
                class="px-6 sty-sect-opt-icon"
                data-user-id="{{ post_data.USER_ID.ID }}"
                onclick="btnUsermsg_post(event)"
              >
                <ion-icon name="chatbox-ellipses"></ion-icon>
              </a>
            </div>
            <a
              class="column sty-sect-opt px-6"
              onclick="mdl_openRequest(event)"
              data-user-id="{{ post_data.USER_ID.ID }}"
              data-post-id="{{ post_data.ID }}"
            >
              <h1 class="">Request</h1>
            </a>
            <div class="column is-3-mobile">
              <h1
                class="px-6 sty-sect-opt-icon"
                data-url="/post/specific/{{ post_data.ID }}"
                onclick="copyLinkPost(event)"
              >
                <ion-icon name="share-outline"></ion-icon>
              </h1>
            </div>
          </div>
          <div class="">
            <h1
              class="has-text-left sty-subtitle-low-font-size sty-font-family-roboto mt-5 sty-subheader-lbl"
            >
              Role Post: {{ post_data.user_role_type }}
            </h1>
          </div>
          <!-- Removing part template: Checking 
          <div class="columns is-0" style="visibility: hidden">
            <div class="column">
              <h1
                id="sty_choice_role"
                class="sty-subtitle-low-font-size sty-font-family-roboto sty-role"
                onclick="role_post_desc()"
              >
                Contributor
              </h1>
            </div>
            <div class="column">
              <h1
                id="sty_choice_role"
                class="sty-subtitle-low-font-size sty-font-family-roboto sty-role"
                onclick="role_post_desc()"
              >
                Innovator
              </h1>
            </div>
            <div class="column">
              <h1
                id="sty_choice_role"
                class="sty-subtitle-low-font-size sty-font-family-roboto sty-role"
                onclick="role_post_desc()"
              >
                Collector
              </h1>
            </div>
          </div>
          -->
          <!-- Hidden Role-->
          <input
            type="text"
            id="inp_role"
            value="{{ post_data.user_role_type }}"
            hidden
          />
          <div class="columns is-vcentered is-mobile">
            <div class="column is-2">
              <h1 class="sty-icon-info">
                <ion-icon name="information-circle"></ion-icon>
              </h1>
            </div>
            <div class="column">
              <h1
                id="desc_onchange"
                class="sty-subtitle-lower-font-size sty-font-family-hind sty-description-lbl"
              >
                description
              </h1>
            </div>
          </div>
        </div>
        <div class="column">
          <div class="columns is-vcentered is-mobile">
            <div class="column is-2">
              <img
                class="is-rounded profile-img-circle"
                src="{{ post_data.USER_ID.profile_picture.url }}"
              />
            </div>
            <div class="column has-text-left sty-mdl-msg">
              <a
                href="/diyconn/profile/get/{{ post_data.USER_ID.username }}"
                style="font-weight: 700; color: black"
                >{{ post_data.USER_ID.username }}</a
              >
              <h1>{{ post_data.modified_at }}</h1>
              <h1>
                <ion-icon name="location"></ion-icon>
                <!-- prettier-ignore- -->
                {{ post_data.USER_ID.city_or_municipality }}
                <!-- prettier-ignore -->
              </h1>
            </div>
          </div>
          <div
            class="sty-inp-postAdd-image sty-inp-IN-image"
            id="btn_inp_image"
          >
            <!-- CSS ISSUE -->
            <h1>
              <ion-icon name="add-circle" style="font-size: 195px"></ion-icon>
            </h1>
            <!-- HIDDEN INPUT FILE -->
            <input
              type="file"
              src=""
              name=""
              id="inp_image"
              accept="image/*"
              hidden
              multiple
            />
          </div>
        </div>
      </div>
      <div class="has-text-centered sty-err-msg" id="err_msg"></div>
    </div>
    {% endif %}
    <!-- prettier-ignore -->

    {% for data in post_data_blob %}
    <img
      data-url="{{ data.blob.url }}"
      src="{{ data.blob.url }}"
      alt="Image Blob"
      class="preview-img"
      hidden
    />

    {% endfor %}
    <div id="get_link" data-url="{% url 'main:diyconn_home' %}" hidden></div>

    <!-- MODAL FOR OPEN Request (STARt)-->
    <div class="modal" id="mdl_Request">
      <div class="modal-background" onclick="mdl_closeRequest()"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title sty-mdl-head has-text-centered">
            FulFill Request
          </p>
          <button
            class="delete"
            aria-label="close"
            onclick="mdl_closeRequest()"
          ></button>
        </header>
        <section class="modal-card-body has-text-centered">
          <h1 class="sty-mdl-msg" id="mdl_content_request">
            Do you want to fullfill the request of "<strong>
              {{ post_data.title }}"</strong
            >"
          </h1>
        </section>
        <!-- Follow auth_registerationProfile to center the btn -->
        <footer class="modal-card-foot">
          <div class="sty-mdl-footer-btn">
            <a class="button sty-mdl-btn-submit" id="btn_fulfill_request">
              Accept</a
            >
          </div>
        </footer>
      </div>
    </div>
    <!-- MODAL FOR OPEN Request (END)-->

    <!-- MODAL FOR IMAGE VIEW (START)-->

    <div class="modal" id="mdl_imageView">
      <button
        onclick="previousViewImage()"
        class="button is-white nav-arrow left-arrow"
      >
        ◀
      </button>
      <div class="modal-background" onclick="mdl_viewImageClose()"></div>

      <div class="modal-content has-text-centered" style="position: relative">
        <!-- Left Arrow -->

        <!-- Image -->
        <p class="image is-4by3">
          <img
            id="mdl_viewImage_element"
            src="https://bulma.io/assets/images/placeholders/1280x960.png"
            alt=""
          />
        </p>

        <!-- Right Arrow -->
      </div>

      <button
        onclick="mdl_viewImageClose()"
        class="modal-close is-large"
      ></button>
      <button
        onclick="nextViewImage()"
        class="button is-white nav-arrow right-arrow"
      >
        ▶
      </button>
    </div>

    <!-- MODAL FOR IMAGE VIEW (END)-->
    {% endblock content %}
    <!-- //prettier-ignore -->

    <script>
      //{% block scripts %}
      // GIVEN
      let usr_all_bck_opt_ref = document.querySelectorAll(
        "#usr_all_bck_opt_ref"
      );
      let get_link = document.getElementById("get_link");
      usr_all_bck_opt_ref.forEach((element) => {
        element.href = get_link.getAttribute("data-url");
      });
      let usr_all_bck_opt_label = document.querySelectorAll(
        "#usr_all_bck_opt_label"
      );
      usr_all_bck_opt_label.forEach((element) => {
        element.textContent = "Retrieve Post";
      });

      function role_initialized() {
        let i = 0;
        let ini_inp_role = document.getElementById("inp_role");
        let ini_desc_onchange = document.getElementById("desc_onchange");
        let role_desc = ini_inp_role.value;
        let sty_choice_role = document.querySelectorAll("#sty_choice_role");
        /*
          sty_choice_role.forEach((el) =>
            el.classList.add("sty-role-not-selected")
          );
          */

        if (role_desc === "Contributor") {
          desc_onchange.innerHTML =
            "A Contributor is an individual who provides materials, resources, or support to a project, organization, or business. <b> As a contributor, you are encouraged to share items that can be repurposed, ensuring they are useful to others. Please only post items that you are willing to give away freely for the benefit of those who can make use of them. </b>";
          inp_role.value = "Contributor";
          i = 0;
        } else if (role_desc === "Innovator") {
          desc_onchange.innerHTML =
            "An Innovator is an  individual who  collects and creatively repurposes items to give them a second life through innovative projects. <b> As an innovator, you should only post projects that you genuinely intend to create</b>, demonstrating how the collected items can be transformed into something new and valuable. By doing so, you contribute to a more sustainable and environmentally friendly community.";
          inp_role.value = "Innovator";
          i = 1;
        } else if (role_desc === "Collector") {
          desc_onchange.innerHTML =
            "A Collector is an individual who gathers recyclable items that can be exchanged for money or other benefits. If you are a collector, you should only <b> post items that you are actively looking to collect and are willing to pick up or receive.</b> This helps facilitate an efficient exchange process while promoting recycling and sustainability.";
          inp_role.value = "Collector";
          i = 2;
        } /*
          sty_choice_role[i].classList.remove("sty-role-not-selected");
          sty_choice_role[i].classList.add("sty-role-selected");
          */
      }
      role_initialized();
      /*
        function blob_ini() {
          const btn_inp_image = document.getElementById("btn_inp_image");
          const err_msg = document.getElementById("err_msg"); // Optional: if you show errors
          const imageElements = document.querySelectorAll(".preview-img");

          const count = imageElements.length;

          // Setup grid layout
          if (count === 1) {
            btn_inp_image.style.gridTemplateColumns = "1fr";
            btn_inp_image.style.gridTemplateRows = "1fr";
          } else if (count === 2) {
            btn_inp_image.style.gridTemplateColumns = "1fr 1fr";
            btn_inp_image.style.gridTemplateRows = "1fr";
          } else if (count === 3 || count === 4) {
            btn_inp_image.style.gridTemplateColumns = "1fr 1fr";
            btn_inp_image.style.gridTemplateRows = "1fr 1fr";
          } else {
            if (err_msg) err_msg.textContent = "Can only take 4 images per post";
            return;
          }

          // Clear container and display as grid
          btn_inp_image.innerHTML = "";
          btn_inp_image.style.display = "grid";

          // Add each image dynamically
          imageElements.forEach((imgEl, index) => {
            const imageUrl = imgEl.dataset.url;

            const img = document.createElement("img");
            img.src = imageUrl;
            img.style.width = "100%";
            img.style.height = "100%";
            img.style.objectFit = "cover";

            if (count === 3 && index === 2) {
              img.style.gridColumn = "1 / span 2";
            }

            btn_inp_image.appendChild(img);
          });

          // Hide inner h1 if exists (optional)
          const textElement = btn_inp_image.querySelector("h1");
          if (textElement) textElement.style.display = "none";
        }

        document.addEventListener("DOMContentLoaded", blob_ini);
      */
      function copyLinkPost(event) {
        const target = event.currentTarget; // More reliable than event.target
        const url = target.getAttribute("data-url");
        const fullUrl = `${window.location.origin}${url}`;

        // Copy to clipboard
        navigator.clipboard
          .writeText(fullUrl)
          .then(() => {
            console.log("Copied to clipboard:", fullUrl);
            alert("Link copied to clipboard!");
          })
          .catch((err) => {
            console.error("Failed to copy:", err);
          });
      }

      //button for messsaging

      function btnUsermsg_post(event) {
        get_user_id = event.currentTarget.getAttribute("data-user-id");
        console.log(`msg link:${get_user_id}`);
        //print(json_data);

        let response = fetch(`/diyconn/messages/add/${get_user_id}`, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
          },
          mode: "same-origin",
        })
          .then((response) => {
            if (!response.ok) {
              // If response status is not OK (400, 500, etc.), throw an error
              return response.json().then((errData) => {
                throw errData;
              });
            }
            return response.json(); // Otherwise, parse the JSON response
          })
          .then((res) => {
            console.log(res);
            window.location.href = res.redirect_url;
          })
          .catch((err) => {
            console.log(err);

            console.log("Error:", err.error || "An unexpected error occurred");
          });
      }

      //Request Modal
      let btn_fulfill_request = document.getElementById("btn_fulfill_request");

      function mdl_openRequest(event) {
        let target = event.currentTarget;
        let get_userID = target.getAttribute("data-user-id");
        let get_postID = target.getAttribute("data-post-id");
        mdl_Request.classList.add("is-active");

        btn_fulfill_request.setAttribute("data-user-id", get_userID);
        btn_fulfill_request.setAttribute("data-post-id", get_postID);
      }

      function mdl_closeRequest() {
        btn_fulfill_request.setAttribute("data-user-id", "");
        btn_fulfill_request.setAttribute("data-post-id", "");
        mdl_Request.classList.remove("is-active");
      }

      btn_fulfill_request.addEventListener("click", (event) => {
        let crr_target = event.currentTarget;
        let get_user_id = crr_target.getAttribute("data-user-id");
        let get_post_id = crr_target.getAttribute("data-post-id");
        //console.log(get_user_id);
        let json_data = {
          post_id: get_post_id,
        };
        //console.log(json_data);

        let response = fetch(`/diyconn/messages/request/add/${get_user_id}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify(json_data),
          mode: "same-origin",
        })
          .then((response) => {
            if (!response.ok) {
              // If response status is not OK (400, 500, etc.), throw an error
              return response.json().then((errData) => {
                throw errData;
              });
            }
            return response.json(); // Otherwise, parse the JSON response
          })
          .then((res) => {
            mdl_closeRequest();
            console.log(res);
            alert(`${res.msg}`);
          })
          .catch((err) => {
            console.log(err);

            console.log("Error:", err.error || "An unexpected error occurred");
          });
      });

      //Image view

      let mdl_imageView = document.getElementById("mdl_imageView");
      let mdl_viewImage_element = document.getElementById(
        "mdl_viewImage_element"
      );
      let globalImageList = [];
      let currentImageIndex = 0;

      // Open modal with images
      function mdl_viewImage(imageArray, clickedIndex = 0) {
        globalImageList = imageArray;
        currentImageIndex = clickedIndex;
        mdl_viewImage_element.src = globalImageList[currentImageIndex];
        mdl_imageView.classList.add("is-active");
      }

      // Close modal
      function mdl_viewImageClose() {
        mdl_imageView.classList.remove("is-active");
        mdl_viewImage_element.src = "";
      }

      // Show next image
      function nextViewImage() {
        if (currentImageIndex + 1 < globalImageList.length) {
          currentImageIndex++;
          mdl_viewImage_element.src = globalImageList[currentImageIndex];
        }
      }

      // Show previous image
      function previousViewImage() {
        if (currentImageIndex - 1 >= 0) {
          currentImageIndex--;
          mdl_viewImage_element.src = globalImageList[currentImageIndex];
        }
      }

      // Grid image preview initializer (including view-on-click)
      function blob_ini() {
        const btn_inp_image = document.getElementById("btn_inp_image");
        const err_msg = document.getElementById("err_msg");
        const imageElements = document.querySelectorAll(".preview-img");

        const count = imageElements.length;
        let imageList = [];

        // Setup grid layout
        if (count === 1) {
          btn_inp_image.style.gridTemplateColumns = "1fr";
          btn_inp_image.style.gridTemplateRows = "1fr";
        } else if (count === 2) {
          btn_inp_image.style.gridTemplateColumns = "1fr 1fr";
          btn_inp_image.style.gridTemplateRows = "1fr";
        } else if (count === 3 || count === 4) {
          btn_inp_image.style.gridTemplateColumns = "1fr 1fr";
          btn_inp_image.style.gridTemplateRows = "1fr 1fr";
        } else {
          if (err_msg) err_msg.textContent = "Can only take 4 images per post";
          return;
        }

        // Clear existing images
        btn_inp_image.innerHTML = "";
        btn_inp_image.style.display = "grid";

        // Add images and bind modal view
        imageElements.forEach((imgEl, index) => {
          const imageUrl = imgEl.dataset.url;
          imageList.push(imageUrl);

          const img = document.createElement("img");
          img.src = imageUrl;
          img.style.width = "100%";
          img.style.height = "100%";
          img.style.objectFit = "cover";

          if (count === 3 && index === 2) {
            img.style.gridColumn = "1 / span 2";
          }

          img.addEventListener("click", () => {
            mdl_viewImage(imageList, index);
          });

          btn_inp_image.appendChild(img);
        });

        // Hide fallback h1 if any
        const textElement = btn_inp_image.querySelector("h1");
        if (textElement) textElement.style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", blob_ini);

      //{% endblock scripts %}
    </script>
  </body>
</html>
