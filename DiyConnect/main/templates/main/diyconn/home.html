{% extends './diyconn_base.html' %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% block title %}
    <title>Home | DIY CONNECT</title>
    {% endblock title %}

    <style>
      /* {% block styles %}*/
      .sty-sect-cl-opt {
        background-color: #283618;
        width: 100%;
      }
      .sty-sect-opt {
        font-size: 40px;
        color: #ffffff;
        border: solid #ffffff 1px;
      }
      .sty-sect-desc {
        font-size: 20px;
        text-align: justify;
        color: black;
        font-family: "Hind Madurai", sans-serif;
        font-weight: 400;
      }
      .sty-sect-header {
        font-size: 64px;
        text-align: left;
        color: black;
        font-family: "Montserrat", sans-serif;
        font-optical-sizing: auto;
        font-weight: 800;
        font-style: normal;
      }
      .sty-sect-opt-icon {
        font-size: 38px;
        color: #ffffff;
      }
      .sty-sect-opt-icon:hover {
        cursor: pointer;
      }
      .sty-inp-postAdd-image {
        background-color: #d9d9d9;
        height: 600px !important;
        width: 560px !important;

        padding-left: 80px;
        padding-right: 80px;

        padding-top: 20px;
        padding-bottom: 20px;
        display: flex;
        justify-content: center; /* Center horizontally */
        align-items: center; /* Center vertically */
        text-align: center; /* Ensure text is centered */
        margin: auto; /* Centers the whole circle in the parent container */
        font-size: 30px;

        font-family: "Montserrat", sans-serif;

        font-weight: 800;
        font-style: normal;
      }
      .sty-inp-img-container {
        display: grid;
        height: 100%;
        width: 100%;
        gap: 5px;
        background: #f0f0f0;
        overflow: hidden;
      }
      .sty-sect-msg-opt:hover {
        cursor: pointer;
      }
      /* FOR VIEWING IMAGES */
      .nav-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 2rem;
        background: rgba(255, 255, 255, 0.6);
        border: none;
        z-index: 10;
      }

      .left-arrow {
        left: 10px;
      }

      .right-arrow {
        right: 10px;
      }

      .nav-arrow:hover {
        background: rgba(255, 255, 255, 0.9);
      }
      /* MOBILE */
      @media (max-width: 768px) {
        .sty-sect-opt-icon {
          background-color: #283618;
          font-size: 30px;
        }
        .sty-sect-opt {
          font-size: 17px;
        }
        .sty-mobile-profile-section {
          display: none;
        }
        .sty-mobile-post-header {
          font-size: 20px;
        }
        .sty-inp-postAdd-image {
          background-color: #d9d9d9;
          height: 290px !important;
          width: 100vw !important;
          margin: 0px 0px 0px 0px;
        }
        .icon_rem_padding {
          padding-left: 0 !important;
          padding-right: 0 !important;
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100% !important;
          height: 100%; /* optional but helpful */
          text-align: center;
        }
        #postContainer {
          width: 100% !important;
          max-width: 100vw !important;
        }

        .side-column {
          width: 100% !important;
        }
        .section {
          padding-left: 0px;
          padding-right: 0px;
          width: 100vw !important;
        }
        .sty-sect-cl-opt {
          width: 100vw !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          padding-left: 0 !important;
          padding-right: 0 !important;
        }
        html,
        body {
          margin: 0;
          padding: 0;
          width: 100%;
          overflow-x: hidden; /* prevents unwanted horizontal scroll */
        }
        .nav-arrow {
          font-size: 1.5rem; /* Slightly smaller for mobile */
          top: 45%;
          padding: 0.3rem 0.6rem;
          background: rgba(255, 255, 255, 0.8);
        }

        .left-arrow {
          left: 5px; /* Tighter margin */
        }

        .right-arrow {
          right: 5px;
        }

        #mdl_viewImage_element {
          max-width: 90vw;
          max-height: 70vh;
          object-fit: contain;
          margin: auto;
        }

        .modal-close {
          top: 5px;
          right: 5px;
        }
      }
      /* {% endblock styles %} */
    </style>
  </head>
  <body>
    <!-- prettier-ignore -->
    {% block content %}
    <!-- //prettier-ignore -->
    <!-- hidden-last-value-post -->
    <!--<input type="text" id="trial_role" value="Innovator" />-->
    <input type="text" name="" id="hidden_last_post_value" value="0" hidden />
    <input
      type="text"
      id="hidden_post_role"
      value="{{ role_post_filter }}"
      hidden
    />
    <!-- TRIALLLL -->

    <div id="postContainer">
      <!-- DRAFT TEMPLATE    
      <div class="container">
        <div class="section is-medium">
          <div class="columns is-vcentered has-text-centered">
            <div class="column">
              <div class="columns is-vcentered">
                <div class="column is-2">
                  <ion-icon name="person-circle"></ion-icon>
                </div>
                <div class="column has-text-left sty-mdl-msg">
                  <h1 style="font-weight: 700">PlasticHunterX</h1>
                  <h1>March 21, 2025</h1>
                  <h1>
                    <ion-icon name="location"></ion-icon>South - 2 Bacoor Cavite
                  </h1>
                </div>
              </div>
              <h1 class="sty-sect-header">300 pcs of Plastics Bottles</h1>
              <h1 class="sty-sect-desc">
                The plastic bottles are clean, all 1.5 liters, with no labels
                and caps removed. They are dry and free from any residue, ready
                for recycling.
              </h1>
              <div class="columns mt-5 is-vcentered sty-sect-cl-opt">
                <div class="column">
                  <h1 class="px-6 sty-sect-opt-icon">
                    <ion-icon name="chatbox-ellipses"></ion-icon>
                  </h1>
                </div>
                <div class="column sty-sect-opt px-6">
                  <h1 class="">Request</h1>
                </div>
                <div class="column">
                  <h1 class="px-6 sty-sect-opt-icon">
                    <ion-icon name="share-outline"></ion-icon>
                  </h1>
                </div>
              </div>
            </div>
            <div class="column">
              <div>
                <img alt="" />
              </div>
            </div>
          </div>
        </div>
      </div>
        -->
    </div>
    <!-- MODAL FOR IMAGE VIEW (START)-->
    <div class="modal" id="mdl_imageView">
      <button
        onclick="previousViewImage()"
        class="button is-white nav-arrow left-arrow"
      >
        ◀
      </button>
      <div class="modal-background" onclick="mdl_viewImageClose()"></div>

      <div class="modal-content has-text-centered" style="position: relative">
        <!-- Left Arrow -->

        <!-- Image -->
        <p class="image is-4by3">
          <img
            id="mdl_viewImage_element"
            src="https://bulma.io/assets/images/placeholders/1280x960.png"
            alt=""
          />
        </p>

        <!-- Right Arrow -->
      </div>

      <button
        onclick="mdl_viewImageClose()"
        class="modal-close is-large"
      ></button>
      <button
        onclick="nextViewImage()"
        class="button is-white nav-arrow right-arrow"
      >
        ▶
      </button>
    </div>

    <!-- MODAL FOR IMAGE VIEW (END)-->

    <!-- MODAL FOR OPEN Request (STARt)-->
    <div class="modal" id="mdl_Request">
      <div class="modal-background" onclick="mdl_closeRequest()"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title sty-mdl-head has-text-centered">
            FulFill Request
          </p>
          <button
            class="delete"
            aria-label="close"
            onclick="mdl_closeRequest()"
          ></button>
        </header>
        <section class="modal-card-body has-text-centered">
          <h1 class="sty-mdl-msg" id="mdl_content_request">
            Do you want to fullfill the request of "<strong>
              -- REQUEST NOTE -- </strong
            >"
          </h1>
        </section>
        <!-- Follow auth_registerationProfile to center the btn -->
        <footer class="modal-card-foot">
          <div class="sty-mdl-footer-btn">
            <a class="button sty-mdl-btn-submit" id="btn_fulfill_request">
              Accept</a
            >
          </div>
        </footer>
      </div>
    </div>
    <!-- MODAL FOR OPEN Request (END)-->

    <!-- prettier-ignore -->
    {% endblock content %}
    <!-- //prettier-ignore -->
    <script>
      //{% block scripts %}

      // INITIALIZED

      function Initilized() {
        let ini_get_all_role_elements = document.querySelectorAll(
          "#nav_getElement_choice_role"
        );
        let ini_navbar_role_show = document.getElementById("navbar_role_show");
        let ini_get_hidden_post_role =
          document.getElementById("hidden_post_role");
        ini_get_all_role_elements.forEach((element) => {
          element.classList.remove("sty-h-role-is-selected");
        });
        let role_check = ini_get_hidden_post_role.value;

        if (role_check === "Contributor") {
          ini_navbar_role_show.textContent = "Contributor";
          // ini_get_hidden_post_role.value = "Contributor";
          ini_get_all_role_elements[1].classList.add("sty-h-role-is-selected");
        } else if (role_check === "Innovator") {
          ini_navbar_role_show.textContent = "Innovator";
          //ini_get_hidden_post_role.value = "Innovator";
          ini_get_all_role_elements[0].classList.add("sty-h-role-is-selected");
        } else if (role_check === "Collector") {
          ini_navbar_role_show.textContent = "Collector";
          // ini_get_hidden_post_role.value = "Collector";
          ini_get_all_role_elements[2].classList.add("sty-h-role-is-selected");
        } else if (role_check === "Showcase") {
          ini_navbar_role_show.textContent = "Showcase";
          // ini_get_hidden_post_role.value = "Collector";
          ini_get_all_role_elements[3].classList.add("sty-h-role-is-selected");
        }
      }
      Initilized();

      function Initilized_mobile() {
        let ini_mobile_dropdown_btn_selected_role = document.getElementById(
          "mobile_dropdown_btn_selected_role"
        );
        let ini_get_all_role_elements = document.querySelectorAll(
          ".select-role-item-mobile"
        );
        let ini_navbar_role_show = document.getElementById("navbar_role_show");
        let ini_get_hidden_post_role =
          document.getElementById("hidden_post_role");
        ini_get_all_role_elements.forEach((element) => {
          element.classList.remove("sty-mobile-selected-role");
        });
        let role_check = ini_get_hidden_post_role.value;

        if (role_check === "Contributor") {
          ini_navbar_role_show.textContent = "Contributor";
          // ini_get_hidden_post_role.value = "Contributor";
          ini_get_all_role_elements[1].classList.add(
            "sty-mobile-selected-role"
          );
          ini_mobile_dropdown_btn_selected_role.innerText = "Contributor";
        } else if (role_check === "Innovator") {
          ini_navbar_role_show.textContent = "Innovator";
          //ini_get_hidden_post_role.value = "Innovator";
          ini_get_all_role_elements[0].classList.add(
            "sty-mobile-selected-role"
          );
          ini_mobile_dropdown_btn_selected_role.innerText = "Innovator";
        } else if (role_check === "Collector") {
          ini_navbar_role_show.textContent = "Collector";
          // ini_get_hidden_post_role.value = "Collector";
          ini_get_all_role_elements[2].classList.add(
            "sty-mobile-selected-role"
          );
          ini_mobile_dropdown_btn_selected_role.innerText = "Collector";
        } else if (role_check === "Showcase") {
          ini_navbar_role_show.textContent = "Showcase";
          // ini_get_hidden_post_role.value = "Collector";
          ini_get_all_role_elements[3].classList.add(
            "sty-mobile-selected-role"
          );
          ini_mobile_dropdown_btn_selected_role.innerText = "Showcase";
        }
      }
      Initilized_mobile();
      // IF WORKS IT WORK
      let hidden_last_post_value = document.getElementById(
        "hidden_last_post_value"
      ).value;

      let postContainer = document.getElementById("postContainer");
      async function fetchNewPost() {
        let hidden_post_role =
          document.getElementById("hidden_post_role").value;
        let response = await fetch(
          `/post/get/${hidden_last_post_value}/${hidden_post_role}`
        );

        try {
          let data = await response.json();

          hidden_last_post_value = data.latest_post_count;
          // TESTING
          console.log(data.new_posts);
          // console.log(data.latest_post_count);
          setTimeout(fetchNewPost, 2000); // Calls again after 2 seconds

          let div_newPost = document.createElement("div");
          div_newPost.classList.add("container");

          //clean_path = image_path.replace("/upload/", "");
          div_newPost.innerHTML = `
      <div class="section is-medium">
             <div class="columns is-vcentered has-text-centered">
               <div class="column side-column">
                  <div class="columns is-vcentered sty-mobile-profile-section ">
                <div class="column is-2">
         
  <img class="is-rounded profile-img-circle" src="${
    data.new_posts.profile_urls
  }" />

                </div>
                <div class="column has-text-left sty-mdl-msg">
                  <a href="/diyconn/profile/get/${
                    data.new_posts.username
                  }/" style="font-weight: 700; color:black">${
            data.new_posts.username
          }</a>
                <h1>${new Date(data.new_posts.date_modified).toLocaleDateString(
                  "en-US",
                  { year: "numeric", month: "long", day: "numeric" }
                )}</h1>
                  <h1><ion-icon name="location"></ion-icon> ${
                    data.new_posts.user_location.subdivision
                  } ${data.new_posts.user_location.city_or_municipality}</h1>
                </div>
              </div>
                 <h1 class="sty-sect-header sty-mobile-post-header">     ${
                   data.new_posts.title
                 }</h1>
                 <h1 class="sty-sect-desc">
                             <p>
                   ${data.new_posts.description}
                   </p>
                      <br>   
                     <p>
                Author:   ${data.new_posts.username} at: ${new Date(
            data.new_posts.date_modified
          ).toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })} 
                   </p>
                   <p>Location: ${data.new_posts.user_location.subdivision} - ${
            data.new_posts.user_location.city_or_municipality
          }</p>
                 </h1>
                 <div class="columns mt-5 is-vcentered sty-sect-cl-opt is-mobile">
                   <div class="column has-text-centered ">
                     <a class="px-6 icon_rem_padding  sty-sect-opt-icon sty-sect-msg-opt" onclick="btnUsermsg_post(event)" data-user-id="${
                       data.new_posts.user
                     }" >
                       <ion-icon name="chatbox-ellipses"></ion-icon>
                     </a>
                   </div>
                   <div class="column sty-sect-opt px-6  ">
                    
                     <h1 
    onclick="${
      data.new_posts.role_post === "Showcase"
        ? `postLike(event)`
        : `mdl_openRequest(event, '${data.new_posts.title.replace(
            /'/g,
            "\\'"
          )}', '${data.new_posts.user}')`
    }" 
    data-post-id="${data.new_posts.id}"
  >
    ${
      data.new_posts.role_post === "Showcase"
        ? `Like: ${data.new_posts.like}`
        : "Accept Request"
    }
  </h1>

                   </div>
                   <div class="column sty-sect-opt-icon has-text-centered">
                     <h1 class="px-6 icon_rem_padding  "data-url="/post/specific/${
                       data.new_posts.id
                     }"  onclick="copyLinkPost(event)">
<ion-icon name="share-outline"></ion-icon>
                     </h1>
                   </div>
                 </div>
               </div>
               <div class="column" onclick="mdl_viewImage('${
                 data.new_posts.blob_url
               }')">
                 <div class="sty-inp-img-container sty-inp-postAdd-image " id='inp_img_container_${
                   data.latest_post_count
                 }'>
                   <img alt="" src= "" />
                 </div>
               </div>
             </div>
           </div>
       `;

          postContainer.appendChild(div_newPost);

          let get_item_inp_img_container = document.getElementById(
            `inp_img_container_${data.latest_post_count}`
          );

          let get_num_images = data.new_posts.blob_url.length;
          // TESTING
          //console.log(`Number of images:${get_num_images}`);
          if (get_num_images == 1) {
            get_item_inp_img_container.style.gridTemplateColumns = "1fr";
            get_item_inp_img_container.style.gridTemplateRows = "1fr";
          } else if (get_num_images == 2) {
            get_item_inp_img_container.style.gridTemplateColumns = "1fr 1fr";
            get_item_inp_img_container.style.gridTemplateRows = "1fr";
          } else if (get_num_images === 3) {
            get_item_inp_img_container.style.gridTemplateColumns = "1fr 1fr";
            get_item_inp_img_container.style.gridTemplateRows = "1fr 1fr";
          } else if (get_num_images == 4) {
            get_item_inp_img_container.style.gridTemplateColumns = "1fr 1fr";
            get_item_inp_img_container.style.gridTemplateRows = "1fr 1fr";
          } else {
            console.log("big file");
          }
          get_item_inp_img_container.innerHTML = "";
          get_item_inp_img_container.style.display = "grid";
          get_images_arr = data.new_posts.blob_url;

          get_images_arr.forEach((element, index) => {
            let imageUrl = element;
            let img = document.createElement("img");
            img.src = imageUrl;
            img.style.width = "100%";
            img.style.height = "100%";
            img.style.objectFit = "cover";

            // If 3 images, make the last one span two columns
            if (get_num_images === 3 && index === 2) {
              img.style.gridColumn = "1 / span 2";
            }

            get_item_inp_img_container.appendChild(img);
          });
        } catch (err) {
          setTimeout(fetchNewPost, 5000);
          console.log(err);
          console.log("There is no new post.");
        }

        // Get the lastest count
      }

      document.addEventListener("DOMContentLoaded", fetchNewPost);
      //---''

      // SEARCH BAR
      let nav_search_bar = document.getElementById("nav_search_bar");
      nav_search_bar.addEventListener("keypress", () => {
        if (event.key === "Enter") {
          event.preventDefault();
          let get_data_search = nav_search_bar.value;
          if (get_data_search === "") {
            return;
          }
          // console.log("Searching..");
          window.location.href = `/diyconnect/search/${get_data_search}`;
        }
      });
      function btnUsermsg_post(event) {
        get_user_id = event.currentTarget.getAttribute("data-user-id");
        console.log(`msg link:${get_user_id}`);
        //print(json_data);

        let response = fetch(`/diyconn/messages/add/${get_user_id}`, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
          },
          mode: "same-origin",
        })
          .then((response) => {
            if (!response.ok) {
              // If response status is not OK (400, 500, etc.), throw an error
              return response.json().then((errData) => {
                throw errData;
              });
            }
            return response.json(); // Otherwise, parse the JSON response
          })
          .then((res) => {
            console.log(res);
            window.location.href = res.redirect_url;
          })
          .catch((err) => {
            console.log(err);

            console.log("Error:", err.error || "An unexpected error occurred");
          });
      }

      function copyLinkPost(event) {
        const target = event.currentTarget; // More reliable than event.target
        const url = target.getAttribute("data-url");
        const fullUrl = `${window.location.origin}${url}`;

        // Copy to clipboard
        navigator.clipboard
          .writeText(fullUrl)
          .then(() => {
            console.log("Copied to clipboard:", fullUrl);
            alert("Link copied to clipboard!");
          })
          .catch((err) => {
            console.error("Failed to copy:", err);
          });
      }

      // FOR MODAL VIEW IMAGE
      let mdl_imageView = document.getElementById("mdl_imageView");
      let mdl_viewImage_element = document.getElementById(
        "mdl_viewImage_element"
      );
      let globalImageList = []; // Declare global variable

      function mdl_viewImage(get_arr_image) {
        globalImageList = get_arr_image.split(","); // Store to global variable
        //console.log(globalImageList); // You can now use this globally

        mdl_viewImage_element.src = globalImageList[0];
        mdl_imageView.classList.add("is-active");
      }
      function nextViewImage() {
        //console.log("Next Image");
        //console.log(globalImageList);

        let currentSrc = mdl_viewImage_element.src;
        let currentIndex = globalImageList.findIndex((path) =>
          currentSrc.endsWith(path)
        );

        if (currentIndex !== -1 && currentIndex + 1 < globalImageList.length) {
          mdl_viewImage_element.src = globalImageList[currentIndex + 1];
        }
      }
      function previousViewImage() {
        let currentSrc = mdl_viewImage_element.src;
        let currentIndex = globalImageList.findIndex((path) =>
          currentSrc.endsWith(path)
        );

        if (currentIndex > 0) {
          mdl_viewImage_element.src = globalImageList[currentIndex - 1];
        }
      }

      let btn_fulfill_request = document.getElementById("btn_fulfill_request");
      btn_fulfill_request.addEventListener("click", (event) => {
        let get_user_id = event.target.getAttribute("data-user-id");
        let get_post_id = event.target.getAttribute("data-post-id");
        //console.log(get_user_id);
        let json_data = {
          post_id: get_post_id,
        };
        //console.log(json_data);

        let response = fetch(`/diyconn/messages/request/add/${get_user_id}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify(json_data),
          mode: "same-origin",
        })
          .then((response) => {
            if (!response.ok) {
              // If response status is not OK (400, 500, etc.), throw an error
              return response.json().then((errData) => {
                throw errData;
              });
            }
            return response.json(); // Otherwise, parse the JSON response
          })
          .then((res) => {
            mdl_closeRequest();
            console.log(res);
            alert(`${res.msg}`);
          })
          .catch((err) => {
            console.log(err);

            console.log("Error:", err.error || "An unexpected error occurred");
          });
      });
      function mdl_viewImageClose() {
        mdl_imageView.classList.remove("is-active");
      }
      let mdl_content_request = document.getElementById("mdl_content_request");
      let mdl_Request = document.getElementById("mdl_Request");
      function mdl_openRequest(event, content, id) {
        console.log(id);

        let target = event.currentTarget;
        let get_post_id = target.getAttribute("data-post-id");
        mdl_content_request.innerHTML = `Do you want to fulfill the request of "<strong style='font-weight:700; color:black'>${content}</strong>"?`;

        mdl_Request.classList.add("is-active");
        btn_fulfill_request.setAttribute("data-user-id", id);
        btn_fulfill_request.setAttribute("data-post-id", get_post_id);
      }

      function mdl_closeRequest() {
        mdl_Request.classList.remove("is-active");
      }

      function ini_alert() {
        let get_navbar_username = document.getElementById(
          "get_navbar_username"
        );

        let rawUsername = get_navbar_username.innerText.trim(); // get the text inside <h1>
        let cleanUsername = rawUsername.replace(/\s+/g, ""); // remove all whitespace

        console.log(cleanUsername); // this will log username without spaces
        if (cleanUsername == "guest") {
          alert(
            "To fully utilize the features of this platform, please create an account or log in."
          );
        }
      }

      ini_alert();

      //POST LIKE
      function postLike(event) {
        let target = event.currentTarget;
        console.log("this is like post");
      }

      //{% endblock scripts%}
    </script>
  </body>
</html>
